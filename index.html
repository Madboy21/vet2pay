<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no"
  />
  <title>Nexos Pay</title>

  <!-- Monetag SDK -->
  <script src="//libtl.com/sdk.js" data-zone="9717667" data-sdk="show_9717667" async></script>

  <!-- Optional second network (kept as-is) -->
  <script
    type="text/javascript"
    src="//pl26604097.profitableratecpm.com/0f/56/94/0f5694f9b53dd9db6b20e82218735b99.js"
    async
  ></script>

  <!-- Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --tg-theme-bg-color: #121212;
      --tg-theme-text-color: #e0e0e0;
      --tg-theme-button-color: #007bff;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-hint-color: #8a8a8a;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --secondary-bg-color: #1e1e1e;
      --border-color: #333333;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px 15px 90px 15px;
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-height: 100vh;
    }
    .container { width: 100%; max-width: 500px; }
    .view { display: none; width: 100%; animation: fadeIn 0.25s ease-in; }
    #home-view { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .header { margin-bottom: 22px; }
    .header h1 { font-size: 30px; font-weight: 800; margin: 0 0 6px; color: #fff; }
    .header p { color: var(--tg-theme-hint-color); font-size: 15px; margin: 0; }
    .card {
      background-color: var(--secondary-bg-color);
      padding: 22px;
      border-radius: 16px;
      margin-bottom: 22px;
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 16px rgba(0,0,0,.18);
      text-align: left;
    }
    .card h2 {
      margin: 0 0 10px;
      font-size: 14px;
      color: var(--tg-theme-hint-color);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .5px;
    }
    .balance-amount { font-size: 40px; font-weight: 800; color: #fff; margin-bottom: 8px; }
    .ad-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      text-align: center;
    }
    .ad-info-item h3 { font-size: 19px; font-weight: 700; margin: 0 0 4px; color: #fff; }
    .ad-info-item p { font-size: 13px; color: var(--tg-theme-hint-color); margin: 0; }
    .ad-buttons { display: flex; flex-direction: column; gap: 14px; margin-bottom: 20px; }
    .btn {
      width: 100%;
      padding: 15px;
      font-size: 17px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
      background: linear-gradient(145deg, var(--tg-theme-button-color), #0056b3);
      color: var(--tg-theme-button-text-color);
      box-shadow: 0 4px 10px rgba(0, 123, 255, .2);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0, 123, 255, .28); }
    .btn:active { transform: scale(.985); }
    .btn:disabled { background: #555; color: #9a9a9a; cursor: not-allowed; box-shadow: none; transform: none; }
    #mainWithdrawBtn {
      background: linear-gradient(145deg, var(--success-color), #1e7e34);
      box-shadow: 0 4px 10px rgba(40, 167, 69, .2);
    }
    #mainWithdrawBtn:disabled { background: #555; box-shadow: none; }
    .banner {
      font-size: 13px;
      padding: 10px 12px;
      border: 1px dashed var(--border-color);
      border-radius: 10px;
      color: var(--tg-theme-hint-color);
      text-align: center;
      margin-bottom: 16px;
    }
    .status-message {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 500px;
      padding: 12px 14px;
      border-radius: 10px;
      font-weight: 600;
      display: none;
      z-index: 1000;
    }
    .success { display: block; background: rgba(40,167,69,.22); border-left: 5px solid var(--success-color); color: var(--success-color); }
    .error { display: block; background: rgba(220,53,69,.22); border-left: 5px solid var(--danger-color); color: var(--danger-color); }
    .info { display: block; background: rgba(0,123,255,.22); border-left: 5px solid var(--tg-theme-button-color); color: #008cff; }
    .footer-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--secondary-bg-color);
      display: flex; justify-content: space-around;
      padding: 9px 0;
      border-top: 1px solid var(--border-color);
      box-shadow: 0 -4px 12px rgba(0,0,0,.28);
      z-index: 999;
    }
    .nav-btn {
      background: none; border: none; color: var(--tg-theme-hint-color);
      display: flex; flex-direction: column; align-items: center;
      font-size: 12px; font-weight: 600; cursor: pointer; padding: 5px 14px;
      border-radius: 12px; transition: color .15s, background-color .15s;
    }
    .nav-btn.active { color: var(--tg-theme-button-color); }
    .nav-btn:hover:not(.active) { color: #fff; }
    .nav-btn .icon { width: 26px; height: 26px; margin-bottom: 3px; }
    .input-group { margin-bottom: 16px; text-align: left; }
    .input-group label { display: block; margin-bottom: 7px; color: var(--tg-theme-hint-color); font-size: 13px; font-weight: 600; }
    .input-group input {
      width: 100%; padding: 13px; border-radius: 10px; border: 1px solid var(--border-color);
      background: #333; color: var(--tg-theme-text-color); font-size: 16px;
    }
    .input-group input:focus {
      outline: none; border-color: var(--tg-theme-button-color);
      box-shadow: 0 0 0 3px rgba(0,123,255,.18);
    }
    #referralLink {
      background: #111; padding: 14px; border-radius: 10px; word-wrap: break-word;
      border: 1px dashed var(--tg-theme-hint-color); margin-top: 12px; cursor: pointer; color: #e0e0e0;
      transition: background .15s; text-align: left;
    }
    #referralLink:hover { background: #2a2a2a; }
    .admin-panel {
      display: none; margin-top: 20px; padding: 12px; border: 1px solid var(--warning-color);
      border-radius: 10px; background: rgba(255,193,7,.08);
    }
    .admin-panel h3 { color: var(--warning-color); margin: 0 0 8px; }
    /* Non-Telegram fallback banner */
    .tg-warning {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      color: var(--warning-color);
      background: rgba(255,193,7,.08);
      font-size: 13px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Home -->
    <div id="home-view" class="view">
      <div class="header">
        <h1>Vet 2 Pay</h1>
        <p>Watch Ads and Earn Vet</p>
      </div>

      <div class="banner">Minimum Withdraw: <b>100 VET</b> · Daily Ad Limit: <b>25</b></div>

      <div class="card">
        <h2>Current Balance</h2>
        <div class="balance-amount" id="balanceDisplay">VET 0.00</div>
        <div class="ad-info-grid">
          <div class="ad-info-item">
            <h3 id="adCountDisplay">0</h3>
            <p>Total Ads Watched</p>
          </div>
          <div class="ad-info-item">
            <h3 id="dailyAdCountDisplay">0 / 25</h3>
            <p>Today's Ads</p>
          </div>
        </div>
      </div>

      <div class="ad-buttons">
        <button class="btn" id="rewardedBtn">Watch Ad (+0.5 VET)</button>
      </div>

      <button class="btn" id="mainWithdrawBtn" disabled>Reach 100.00 VET to Withdraw</button>

      <div id="tgWarning" class="tg-warning">
        Open this page from Telegram (via your bot’s Web App) to enable earning and withdrawal.
      </div>
    </div>

    <!-- Withdraw -->
    <div id="withdraw-view" class="view">
      <div class="header">
        <h1>Withdraw</h1>
        <p>Request your earnings</p>
      </div>

      <div class="card">
        <h2>Your Balance</h2>
        <div class="balance-amount" id="withdrawBalanceDisplay">VET 0.00</div>
        <p style="color: var(--tg-theme-hint-color); margin-top: 10px;">
          Minimum withdrawal is <b>100.00 VET</b>.
        </p>
      </div>

      <div class="card">
        <h2>Payment Details</h2>
        <div class="input-group">
          <label for="paymentAddress">Your VET Wallet (BEP20)</label>
          <input type="text" id="paymentAddress" placeholder="e.g., 0x... (BEP20 Address)" />
        </div>
        <button class="btn" id="finalWithdrawBtn" disabled>Withdraw</button>
      </div>
    </div>

    <!-- Referral -->
    <div id="referral-view" class="view">
      <div class="header">
        <h1>Referrals</h1>
        <p>Invite friends and earn more!</p>
      </div>

      <div class="card">
        <h2>Your Referral Stats</h2>
        <div class="ad-info-grid">
          <div class="ad-info-item">
            <h3 id="referralCountDisplay">0</h3>
            <p>Total Referrals</p>
          </div>
          <div class="ad-info-item">
            <h3 id="referralBonusDisplay">VET 0.00</h3>
            <p>Referral Earnings (local)</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Your Referral Link</h2>
        <p>Share this link. You get <b>0.50 VET</b> per verified friend (backend required).</p>
        <p id="referralLink" title="Click to copy"></p>
        <p style="font-size:12px; color:var(--tg-theme-hint-color); margin-top:10px;">
          Note: Referral rewards require backend verification.
        </p>
      </div>
    </div>

    <!-- Common -->
    <div class="status-message" id="statusMessage"></div>
    <div class="admin-panel" id="adminPanel">
      <h3>👑 Admin Panel</h3>
      <p id="userInfo"></p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer-nav">
    <button class="nav-btn active" id="navHome">
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      </span>
      <span>Home</span>
    </button>
    <button class="nav-btn" id="navWithdraw">
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.31 8.91a1 1 0 0 0-1.42 0l-4.24 4.24-2.12-2.12a1 1 0 1 0-1.42 1.42l2.83 2.83a1 1 0 0 0 1.42 0l5-5a1 1 0 0 0 0-1.42zM20 12a8 8 0 1 1-8-8 8 8 0 0 1 8 8zm-2 0a6 6 0 1 0-6 6 6 6 0 0 0 6-6z"/></svg>
      </span>
      <span>Withdraw</span>
    </button>
    <button class="nav-btn" id="navRefer">
      <span class="icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V18h14v-1.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V18h6v-1.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
      </span>
      <span>Referrals</span>
    </button>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Telegram presence guard
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      const tgWarning = document.getElementById('tgWarning');
      if (!tg) {
        if (tgWarning) tgWarning.style.display = 'block';
      }

      // --- DOM ---
      const els = {
        balanceDisplay: document.getElementById('balanceDisplay'),
        adCountDisplay: document.getElementById('adCountDisplay'),
        dailyAdCountDisplay: document.getElementById('dailyAdCountDisplay'),
        rewardedBtn: document.getElementById('rewardedBtn'),
        mainWithdrawBtn: document.getElementById('mainWithdrawBtn'),
        statusMessage: document.getElementById('statusMessage'),
        withdrawBalanceDisplay: document.getElementById('withdrawBalanceDisplay'),
        paymentAddressInput: document.getElementById('paymentAddress'),
        finalWithdrawBtn: document.getElementById('finalWithdrawBtn'),
        referralLinkDisplay: document.getElementById('referralLink'),
        referralCountDisplay: document.getElementById('referralCountDisplay'),
        referralBonusDisplay: document.getElementById('referralBonusDisplay'),
        adminPanel: document.getElementById('adminPanel'),
        userInfoDisplay: document.getElementById('userInfo'),
      };

      // --- Config ---
      const ADMIN_ID = 1290305525;     // your Telegram numeric user id
      const BOT_USERNAME = 'vet2pay_bot';  // @ without @
      const WEBAPP_NAME = 'vet2pay_bot';   // bot's webapp short name

      // VET units (we'll treat 1.00 VET as 100 cents-like units)
      const WITHDRAW_THRESHOLD_VET = 10000; // 100.00 VET (in "cents")
      const AD_REWARD_VET_CENTS = 50;        // 0.01 VET
      const REFERRAL_BONUS_VET = 20;        // 0.50 VET (display only; real logic needs backend)
      const DAILY_AD_LIMIT = 1000;

      // --- State ---
      let state = {
        balanceInCents: 0,
        totalAdCount: 0,
        dailyAdCount: 0,
        lastAdDate: null,
        referralCount: 0,
      };

      function todayStr() { return new Date().toISOString().split('T')[0]; }

      function loadState() {
        try {
          const saved = JSON.parse(localStorage.getItem('earningAppVETState'));
          if (saved) state = { ...state, ...saved };
        } catch (e) { console.error('Load state error', e); }
        if (state.lastAdDate !== todayStr()) {
          state.dailyAdCount = 0;
          state.lastAdDate = todayStr();
          saveState();
        }
      }

      function saveState() {
        try { localStorage.setItem('earningAppVETState', JSON.stringify(state)); }
        catch (e) { console.error('Save state error', e); }
      }

      // --- UI ---
      function setStatus(message, type, ms = 3500) {
        const el = els.statusMessage;
        if (!el) return;
        el.textContent = message;
        el.className = 'status-message ' + type;
        el.style.display = 'block';
        clearTimeout(setStatus._t);
        setStatus._t = setTimeout(() => { el.style.display = 'none'; }, ms);
      }

      function updateUI() {
        const bal = (state.balanceInCents / 100).toFixed(2);
        els.balanceDisplay.textContent = `VET ${bal}`;
        els.withdrawBalanceDisplay.textContent = `VET ${bal}`;
        els.adCountDisplay.textContent = state.totalAdCount;
        els.dailyAdCountDisplay.textContent = `${state.dailyAdCount} / ${DAILY_AD_LIMIT}`;

        const canWithdraw = state.balanceInCents >= WITHDRAW_THRESHOLD_VET;
        els.mainWithdrawBtn.disabled = !canWithdraw;
        els.mainWithdrawBtn.textContent = canWithdraw ? `Go to Withdraw`
          : `Reach ${(WITHDRAW_THRESHOLD_VET / 100).toFixed(2)} VET to Withdraw`;

        els.finalWithdrawBtn.disabled = !canWithdraw;
        els.finalWithdrawBtn.textContent = canWithdraw
          ? `Withdraw ${bal} VET`
          : `Minimum ${(WITHDRAW_THRESHOLD_VET / 100).toFixed(2)} VET required`;

        const limitReached = state.dailyAdCount >= DAILY_AD_LIMIT;
        els.rewardedBtn.disabled = limitReached || !window.__adReady;
        if (!window.__adReady) {
          els.rewardedBtn.textContent = 'Loading Ads...';
        } else {
          els.rewardedBtn.textContent = limitReached ? 'Daily Limit Reached' : 'Watch Ad (+0.5 VET)';
        }

        // Referral display (local only)
        els.referralCountDisplay.textContent = state.referralCount;
        const refBonus = ((state.referralCount * REFERRAL_BONUS_VET) / 100).toFixed(2);
        els.referralBonusDisplay.textContent = `VET ${refBonus}`;
      }

      function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        const el = document.getElementById(id);
        if (el) el.style.display = 'block';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        const map = { 'home-view': 'navHome', 'withdraw-view': 'navWithdraw', 'referral-view': 'navRefer' };
        const active = document.getElementById(map[id]);
        if (active) active.classList.add('active');
      }

      // --- Ad SDK readiness ---
      window.__adReady = false;
      function waitForAdFunction(retries = 40) {
        if (typeof window.show_9717667 === 'function') {
          window.__adReady = true;
          updateUI();
          return;
        }
        if (retries <= 0) return;
        setTimeout(() => waitForAdFunction(retries - 1), 250);
      }
      // kick off readiness check
      waitForAdFunction();

      function onAdSuccess() {
        state.totalAdCount++;
        state.dailyAdCount++;
        state.lastAdDate = todayStr();
        state.balanceInCents += AD_REWARD_VET_CENTS;
        saveState();
        updateUI();
        setStatus(`+${(AD_REWARD_VET_CENTS / 100).toFixed(2)} VET added!`, 'success');
      }
      function onAdError(err) {
        console.error('Ad error', err);
        setStatus('Failed to load ad. Please try again.', 'error');
      }
      function requestAd() {
        if (!window.__adReady) {
          setStatus('Ads are still loading, please wait...', 'info');
          return;
        }
        if (state.dailyAdCount >= DAILY_AD_LIMIT) {
          setStatus("You've reached the daily ad limit.", 'error');
          return;
        }
        setStatus('Loading ad...', 'info');
        try {
          const p = window.show_9717667 && window.show_9717667();
          // handle both promise and non-promise
          if (p && typeof p.then === 'function') {
            p.then(onAdSuccess).catch(onAdError);
          } else {
            // some SDKs are callback-only; assume success after short delay
            setTimeout(onAdSuccess, 1200);
          }
        } catch (e) { onAdError(e); }
      }

      // --- Withdraw (BEP20 validation) ---
      function isValidBEP20(addr) {
        return /^0x[a-fA-F0-9]{40}$/.test(addr);
      }
      function handleWithdraw() {
        const wallet = els.paymentAddressInput.value.trim();
        if (state.balanceInCents < WITHDRAW_THRESHOLD_VET) {
          setStatus(`You need at least ${(WITHDRAW_THRESHOLD_VET / 100).toFixed(2)} VET to withdraw.`, 'error');
          return;
        }
        if (!isValidBEP20(wallet)) {
          setStatus('Please enter a valid BEP20 wallet address (0x... 42 chars).', 'error');
          return;
        }
        const balVET = (state.balanceInCents / 100).toFixed(2);
        const user = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
        const message =
`--- Withdrawal Request ---
User ID: ${user ? user.id : 'N/A'}
Name: ${user ? (user.first_name + ' ' + (user.last_name || '')) : 'N/A'}
Username: ${user && user.username ? '@' + user.username : 'N/A'}

Amount: ${balVET} VET
Wallet (BEP20): ${wallet}`;
        if (tg && tg.sendData) {
          tg.sendData(message);
          setStatus('Your withdrawal request has been sent for review.', 'success');
          // reset local balance
          state.balanceInCents = 0;
          saveState();
          updateUI();
          els.paymentAddressInput.value = '';
          showView('home-view');
        } else {
          setStatus('Open from Telegram to submit withdrawal.', 'error');
        }
      }

      // --- Referral link (display only) ---
      function generateReferralLink() {
        const user = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
        if (user && user.id && BOT_USERNAME && WEBAPP_NAME) {
          els.referralLinkDisplay.textContent =
            `https://t.me/vet2pay_bot?startapp=ref${user.id}`;
        } else {
          els.referralLinkDisplay.textContent =
            'Open via Telegram to generate your referral link.';
          els.referralLinkDisplay.style.color = 'var(--warning-color)';
          els.referralLinkDisplay.style.cursor = 'default';
        }
      }

      function handleReferralStart() {
        if (!tg || !tg.initDataUnsafe) return;
        if (tg.initDataUnsafe.start_param) {
          const referrerId = tg.initDataUnsafe.start_param.replace('ref', '');
          console.log('Referral param detected. Referrer:', referrerId);
          // Only UX message; real crediting needs backend API.
          setStatus('Welcome! You joined via a referral link.', 'success', 4500);
        }
      }

      // --- Events ---
      els.rewardedBtn.addEventListener('click', requestAd);
      els.finalWithdrawBtn.addEventListener('click', handleWithdraw);
      document.getElementById('navHome').addEventListener('click', () => showView('home-view'));
      document.getElementById('navWithdraw').addEventListener('click', () => showView('withdraw-view'));
      document.getElementById('navRefer').addEventListener('click', () => showView('referral-view'));
      els.mainWithdrawBtn.addEventListener('click', () => showView('withdraw-view'));
      els.referralLinkDisplay.addEventListener('click', () => {
        const text = els.referralLinkDisplay.textContent || '';
        if (navigator.clipboard && text.startsWith('https://')) {
          navigator.clipboard.writeText(text)
            .then(() => setStatus('Referral link copied!', 'success'))
            .catch(() => setStatus('Could not copy link.', 'error'));
        }
      });

      // --- Init ---
      function init() {
        if (tg) { tg.ready(); tg.expand(); }
        loadState();
        updateUI();
        generateReferralLink();
        handleReferralStart();

        const user = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
        if (user && user.id === ADMIN_ID) {
          els.adminPanel.style.display = 'block';
          els.userInfoDisplay.textContent =
            `Welcome, Admin! User: ${user.first_name} (@${user.username || 'N/A'}), ID: ${user.id}`;
        }
      }
      init();
    });
  </script>
</body>
</html>
